<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <style>
        :root {
            color-scheme: light dark;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: transparent;
            color: inherit;
        }
        .status-panel {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 16px;
            background: rgba(255,255,255,0.65);
            backdrop-filter: blur(8px);
        }
        @media (prefers-color-scheme: dark) {
            .status-panel {
                background: rgba(15,17,26,0.55);
                border-color: rgba(255,255,255,0.08);
            }
        }
        .status-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 8px;
        }
        .status-header strong {
            font-size: 1rem;
        }
        .status-progress {
            position: relative;
            width: 100%;
            height: 16px;
            background: rgba(0,0,0,0.08);
            border-radius: 999px;
            overflow: hidden;
        }
        @media (prefers-color-scheme: dark) {
            .status-progress {
                background: rgba(255,255,255,0.1);
            }
        }
        .status-progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            transition: width 0.4s ease;
        }
        .status-progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-top: 4px;
            color: rgba(0,0,0,0.7);
        }
        @media (prefers-color-scheme: dark) {
            .status-progress-labels {
                color: rgba(255,255,255,0.7);
            }
        }
        .status-message {
            margin: 12px 0;
            font-size: 0.95rem;
        }
        .status-warning {
            margin-bottom: 12px;
            color: #b7791f;
            font-size: 0.9rem;
        }
        .log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .log-block {
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            height: 240px;
        }
        @media (prefers-color-scheme: dark) {
            .log-block {
                background: rgba(255,255,255,0.05);
            }
        }
        .log-title {
            font-weight: 600;
            margin-bottom: 6px;
        }
        pre {
            flex: 1;
            margin: 0;
            padding: 8px;
            border-radius: 6px;
            background: rgba(0,0,0,0.05);
            overflow-y: auto;
            font-size: 0.82rem;
            white-space: pre-wrap;
        }
        @media (prefers-color-scheme: dark) {
            pre {
                background: rgba(255,255,255,0.05);
            }
        }
    </style>
</head>
<body>
    <div class="status-panel" data-episode="__EPISODE_ID__">
        <div class="status-header">
            <strong id="status-stage">Full Pipeline → Starting</strong>
            <span id="status-timestamp"></span>
        </div>
        <div class="status-progress" aria-live="polite">
            <div class="status-progress-bar" id="status-progress-bar"></div>
        </div>
        <div class="status-progress-labels">
            <span id="status-message">Starting Detect/Embed → Track → Cluster → Stills…</span>
            <span id="status-pct">0%</span>
        </div>
        <div class="status-warning" id="status-warning"></div>
        <div class="log-grid">
            <div class="log-block">
                <div class="log-title">Debug Console</div>
                <pre id="debug-log">Waiting for workspace debug output…</pre>
            </div>
            <div class="log-block">
                <div class="log-title">Progress Log</div>
                <pre id="progress-log">Waiting for pipeline progress entries…</pre>
            </div>
        </div>
    </div>
    <script id="status-initial-data" type="application/json">__INITIAL_DATA__</script>
    <script>
        (function () {
            const panel = document.querySelector(".status-panel");
            if (!panel) {
                return;
            }

            const episodeId = panel.dataset.episode || "";
            const stageEl = document.getElementById("status-stage");
            const messageEl = document.getElementById("status-message");
            const pctEl = document.getElementById("status-pct");
            const progressBarEl = document.getElementById("status-progress-bar");
            const timestampEl = document.getElementById("status-timestamp");
            const debugLogEl = document.getElementById("debug-log");
            const progressLogEl = document.getElementById("progress-log");
            const warningEl = document.getElementById("status-warning");
            const initialDataEl = document.getElementById("status-initial-data");

            let retryMs = 2000;

            function formatLines(lines) {
                if (!lines || !lines.length) {
                    return "No entries yet.";
                }
                return lines.join("\\n");
            }

            function applySnapshot(snapshot) {
                if (!snapshot || typeof snapshot !== "object") {
                    return;
                }

                const progress = snapshot.progress || {};
                const pipeline = snapshot.pipeline_state || {};
                const stage = progress.stage || pipeline.current_step || "Full Pipeline";
                const message = progress.message || pipeline.message || "";
                const pct = Math.max(0, Math.min(1, Number(progress.pct || pipeline.pct || 0)));

                stageEl.textContent = `Full Pipeline → ${stage}`;
                messageEl.textContent = message || "Working…";
                pctEl.textContent = `${Math.round(pct * 100)}%`;
                progressBarEl.style.width = `${(pct * 100).toFixed(1)}%`;
                timestampEl.textContent = snapshot.ts ? new Date(snapshot.ts).toLocaleTimeString() : "";

                const logs = snapshot.logs || {};
                debugLogEl.textContent = formatLines(logs.workspace);
                progressLogEl.textContent = formatLines(logs.progress);
            }

            function parseInitialData() {
                if (!initialDataEl) {
                    return;
                }
                try {
                    const payload = JSON.parse(initialDataEl.textContent || "{}");
                    applySnapshot(payload);
                } catch (error) {
                    console.warn("Unable to parse initial status payload", error);
                }
            }

            async function tick() {
                if (!episodeId) {
                    warningEl.textContent = "⚠️ Missing episode identifier.";
                    return;
                }

                try {
                    const response = await fetch(`/api/status?episode_id=${encodeURIComponent(episodeId)}`, {
                        cache: "no-store",
                    });

                    if (!response.ok) {
                        throw new Error(`Status ${response.status}`);
                    }

                    const payload = await response.json();
                    applySnapshot(payload);
                    warningEl.textContent = "";
                    retryMs = 2000;
                } catch (error) {
                    warningEl.textContent = "⚠️ Live snapshot unavailable. Falling back to last known data…";
                    console.warn("Status panel fetch error", error);
                    retryMs = Math.min(retryMs * 1.5, 10000);
                } finally {
                    setTimeout(tick, retryMs);
                }
            }

            parseInitialData();
            tick();
        })();
    </script>
</body>
</html>
